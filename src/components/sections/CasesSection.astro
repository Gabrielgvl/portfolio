---
import SectionHeader from '@/components/ui/SectionHeader.astro';
import Button from '@/components/ui/Button.astro';

interface CaseMetric {
  value: string;
  label: string;
}

interface CaseItem {
  slug: string;
  company: string;
  headline: string;
  result: string;
  stack: string[];
  metrics: CaseMetric[];
  logo?: string;
}

interface Props {
  t: (key: string) => string;
  cases: CaseItem[];
  basePath: string;
}

const { t, cases, basePath } = Astro.props;

const parseMetric = (value: string) => {
  const match = value.match(/-?\d+(?:\.\d+)?/);
  if (!match) return { numeric: null, prefix: '', suffix: '' };
  const numeric = Number(match[0]);
  const index = value.indexOf(match[0]);
  return {
    numeric,
    prefix: value.slice(0, index),
    suffix: value.slice(index + match[0].length),
  };
};
---

<section id="cases" class="py-20 bg-slate-50 dark:bg-slate-950/40">
  <div class="container mx-auto px-4">
    <SectionHeader
      eyebrow={t('cases.section_label')}
      title={t('cases.title')}
      description={t('cases.description')}
    />

    <div class="reveal-group mt-12 grid grid-cols-1 lg:grid-cols-2 gap-6">
      {cases.map((caseItem) => (
        <article class="reveal-item glass-surface rounded-2xl p-7 border border-slate-800/70">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div class="flex items-center gap-3">
              {caseItem.logo ? (
                <img src={caseItem.logo} alt={caseItem.company} class="h-8 opacity-80" loading="lazy" />
              ) : null}
              <span class="text-sm uppercase tracking-[0.2em] text-slate-500">{caseItem.company}</span>
            </div>
            <span class="text-xs text-slate-500 sm:text-right">{t('cases.card.label')}</span>
          </div>

          <h3 class="mt-5 text-xl font-semibold text-slate-900 dark:text-slate-100">
            {caseItem.headline}
          </h3>
          <p class="mt-3 text-sm text-slate-600 dark:text-slate-400">{caseItem.result}</p>

          <div class="mt-6 grid grid-cols-2 gap-4">
            {caseItem.metrics.map((metric) => {
              const parsed = parseMetric(metric.value);
              return (
                <div>
                  <div
                    class="metric-value text-2xl font-semibold font-mono text-accent-500 dark:text-accent-300"
                    data-value={parsed.numeric ?? undefined}
                    data-prefix={parsed.prefix}
                    data-suffix={parsed.suffix}
                  >
                    {metric.value}
                  </div>
                <div class="text-xs uppercase tracking-[0.2em] text-slate-500">
                  {metric.label}
                </div>
              </div>
            );
          })}
          </div>

          <div class="mt-6">
            <Button href={`${basePath}/${caseItem.slug}`} variant="outline" size="sm">
              {t('cases.view_case')}
            </Button>
          </div>
        </article>
      ))}
    </div>
  </div>
</section>
